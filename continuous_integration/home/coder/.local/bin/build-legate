#!/usr/bin/env bash


build_legate_all() {
    build-legate-cpp;
    build-legate-wheel;
    build-legate-conda;
}

build_legate_release() {
    . conda-utils
    activate_conda_env
    mkdir -p /tmp/env_yaml /tmp/conda-build
    conda env export > /tmp/env_yaml/pre_build.yml
    cd legate
    conda mambabuild --output-folder /tmp/conda-build -c nvidia -c conda-forge --no-include-recipe conda/conda-build
    conda env export > /tmp/env_yaml/post_build.yml
}

build_legate() {
    set -x
    cd ~/;

    conda info

    set -eo pipefail;

    case "$1" in
        ci) build_legate_all;;
        release) build_legate_release;;
        *) return 1;;
    esac
}

(build_legate "$@");
