#!/usr/bin/env bash

get_yaml_and_make_conda_env() {
    set -e;

    local cuda_version="${CUDA_VERSION:-${CUDA_VERSION_MAJOR}.${CUDA_VERSION_MINOR}}";
    cuda_version="$(echo "${cuda_version}" | cut -d'.' -f3 --complement)";

    local python_version="${PYTHON_VERSION:-}";

    if [ -z "${python_version}" ]; then
        python_version="$(python3 --version 2>&1 | cut -d' ' -f2 | cut -d'.' -f3 --complement)";
    fi

    mkdir -p ~/.artifacts;
    cd ~/.artifacts;

    local yaml_file=~/.artifacts/"$(            \
        ~/legate/scripts/generate-conda-envs.py \
            --os linux                          \
            --compilers                         \
            --ctk ${cuda_version}               \
            --python ${python_version}          \
            --openmpi                           \
            --no-ucx                            \
        | head -n1 | cut -d' ' -f3              \
    )"

    sed -i -re "s/legate-test/${DEFAULT_CONDA_ENV:-legate}/g" "${yaml_file}";
    echo "  - boa" >> "${yaml_file}";

    echo YAML file: "${yaml_file}"
    cat "${yaml_file}";

    mamba env create -v -n "${DEFAULT_CONDA_ENV:-legate}" -f "${yaml_file}";
}

get_yaml_and_make_conda_env "$@";
